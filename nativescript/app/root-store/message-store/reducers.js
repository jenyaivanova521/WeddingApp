"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var actions_1 = require("./actions");
var state_1 = require("./state");
var app_config_1 = require("../../shared/configs/app.config");
function reducer(state, action) {
    if (state === void 0) { state = state_1.initialState; }
    var index;
    var updatedConversations = [];
    var unreadMessagesCount;
    switch (action.type) {
        case actions_1.MessageActionTypes.APPEND_CONVERSATIONS:
            var conversationsToAppend_1 = {};
            action.payload.conversations.map(function (item, index) {
                if (item.id !== state.activeConversationId) {
                    item.unreadMessagesCount = 0;
                }
                conversationsToAppend_1[item.id] = item;
            });
            for (var i = 0; i < state.conversations.length; i++) {
                var conversation = state.conversations[i];
                if (conversationsToAppend_1[conversation.id]) {
                    delete conversationsToAppend_1[conversation.id];
                }
            }
            return tslib_1.__assign({}, state, { conversations: state.conversations.concat(Object.values(conversationsToAppend_1)), infiniteScroll: tslib_1.__assign({}, state.infiniteScroll, { page: action.payload.infiniteScroll.page, disabled: action.payload.infiniteScroll.disabled }) });
        case actions_1.MessageActionTypes.UPDATE_CONVERSATION_LAST_MESSAGE:
            var conversationToUpdate = void 0;
            unreadMessagesCount = state.unreadMessagesCount;
            for (var i = 0; i < state.conversations.length; i++) {
                var conversation = Object.assign({}, state.conversations[i]);
                if (conversation.id == action.payload.conversationId) {
                    conversationToUpdate = conversation;
                }
                else {
                    updatedConversations.push(conversation);
                }
            }
            if (conversationToUpdate) {
                conversationToUpdate.lastMessage = action.payload.lastMessage;
                updatedConversations.unshift(conversationToUpdate);
            }
            if (state.activeConversationId !== conversationToUpdate.id) {
                var sound = new Audio(app_config_1.CDN_URL + '/sounds/message.mp3');
                sound.play();
                conversationToUpdate.unreadMessagesCount++;
                unreadMessagesCount++;
            }
            return tslib_1.__assign({}, state, { conversations: updatedConversations, unreadMessagesCount: unreadMessagesCount });
        case actions_1.MessageActionTypes.SET_UNREAD_MESSAGES_COUNT:
            return tslib_1.__assign({}, state, { unreadMessagesCount: action.payload.unreadMessagesCount });
        case actions_1.MessageActionTypes.SET_ACTIVE_CONVERSATION_ID:
            if (!action.payload.activeConversationId) {
                return tslib_1.__assign({}, state, { activeConversationId: null });
            }
            updatedConversations = state.conversations.map(function (item, index) {
                if (item.id !== action.payload.activeConversationId) {
                    return item;
                }
                unreadMessagesCount = state.unreadMessagesCount - parseInt(item.unreadMessagesCount);
                return tslib_1.__assign({}, item, { unreadMessagesCount: 0 });
            });
            return tslib_1.__assign({}, state, { activeConversationId: action.payload.activeConversationId, conversations: updatedConversations, unreadMessagesCount: unreadMessagesCount });
        case actions_1.MessageActionTypes.APPEND_NEW_CONVERSATION:
            unreadMessagesCount = state.unreadMessagesCount;
            if (!action.payload.self) {
                var sound = new Audio(app_config_1.CDN_URL + '/sounds/message.mp3');
                sound.play();
                unreadMessagesCount++;
            }
            return tslib_1.__assign({}, state, { conversations: [
                    action.payload.conversation
                ].concat(state.conversations), unreadMessagesCount: unreadMessagesCount });
        default:
            return state;
    }
}
exports.reducer = reducer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkdWNlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWR1Y2Vycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxxQ0FBK0Q7QUFDL0QsaUNBQThDO0FBQzlDLDhEQUEwRDtBQUcxRCxpQkFBd0IsS0FBb0IsRUFBRSxNQUFzQjtJQUE1QyxzQkFBQSxFQUFBLFFBQVEsb0JBQVk7SUFFeEMsSUFBSSxLQUFLLENBQUM7SUFDVixJQUFJLG9CQUFvQixHQUFHLEVBQUUsQ0FBQztJQUM5QixJQUFJLG1CQUFtQixDQUFDO0lBQ3hCLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2xCLEtBQUssNEJBQWtCLENBQUMsb0JBQW9CO1lBQ3hDLElBQUksdUJBQXFCLEdBQUcsRUFBRSxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxVQUFDLElBQUksRUFBRSxLQUFLO2dCQUN6QyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUM7b0JBQ3pDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxDQUFDLENBQUE7Z0JBQ2hDLENBQUM7Z0JBQ0QsdUJBQXFCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUMxQyxDQUFDLENBQUMsQ0FBQztZQUNILEdBQUcsQ0FBQSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDakQsSUFBSSxZQUFZLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDMUMsRUFBRSxDQUFBLENBQUMsdUJBQXFCLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEMsT0FBTyx1QkFB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QUNDLElBQUksSUFDUCxtQkFBbUIsRUFBRSxDQUFDLElBQ3hCO1lBQ04sQ0FBQyxDQUFDLENBQUM7WUFDSCxNQUFNLHNCQUNDLEtBQUssSUFDUixvQkFBb0IsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLG9CQUFvQixFQUN6RCxhQUFhLEVBQUUsb0JBQW9CLEVBQ25DLG1CQUFtQixFQUFFLG1CQUFtQixJQUMzQztRQUNMLEtBQUssNEJBQWtCLENBQUMsdUJBQXVCO1lBQzNDLG1CQUFtQixHQUFHLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQztZQUNoRCxFQUFFLENBQUEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsb0JBQU8sR0FBRyxxQkFBcUIsQ0FBQyxDQUFDO2dCQUN2RCxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2IsbUJBQW1CLEVBQUUsQ0FBQztZQUMxQixDQUFDO1lBQ0QsTUFBTSxzQkFDQyxLQUFLLElBQ1IsYUFBYTtvQkFDVCxNQUFNLENBQUMsT0FBTyxDQUFDLFlBQVk7eUJBQ3hCLEtBQUssQ0FBQyxhQUFhLEdBRTFCLG1CQUFtQixFQUFFLG1CQUFtQixJQUMxQztRQUNOO1lBQ0ksTUFBTSxDQUFDLEtBQUssQ0FBQztJQUNyQixDQUFDO0FBRUwsQ0FBQztBQXpHRCwwQkF5R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3Rpb24gfSBmcm9tICdAbmdyeC9zdG9yZSc7XHJcbmltcG9ydCB7IE1lc3NhZ2VBY3Rpb25zLCBNZXNzYWdlQWN0aW9uVHlwZXMgfSBmcm9tICcuL2FjdGlvbnMnO1xyXG5pbXBvcnQgeyBpbml0aWFsU3RhdGUsIFN0YXRlIH0gZnJvbSAnLi9zdGF0ZSc7XHJcbmltcG9ydCB7IENETl9VUkwgfSBmcm9tICcuLi8uLi9zaGFyZWQvY29uZmlncy9hcHAuY29uZmlnJztcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVkdWNlcihzdGF0ZSA9IGluaXRpYWxTdGF0ZSwgYWN0aW9uOiBNZXNzYWdlQWN0aW9ucykge1xyXG5cclxuICAgIGxldCBpbmRleDtcclxuICAgIGxldCB1cGRhdGVkQ29udmVyc2F0aW9ucyA9IFtdO1xyXG4gICAgbGV0IHVucmVhZE1lc3NhZ2VzQ291bnQ7XHJcbiAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XHJcbiAgICAgICAgY2FzZSBNZXNzYWdlQWN0aW9uVHlwZXMuQVBQRU5EX0NPTlZFUlNBVElPTlM6XHJcbiAgICAgICAgICAgIGxldCBjb252ZXJzYXRpb25zVG9BcHBlbmQgPSB7fTtcclxuICAgICAgICAgICAgYWN0aW9uLnBheWxvYWQuY29udmVyc2F0aW9ucy5tYXAoKGl0ZW0sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5pZCAhPT0gc3RhdGUuYWN0aXZlQ29udmVyc2F0aW9uSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpdGVtLnVucmVhZE1lc3NhZ2VzQ291bnQgPSAwXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25zVG9BcHBlbmRbaXRlbS5pZF0gPSBpdGVtO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHN0YXRlLmNvbnZlcnNhdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGxldCBjb252ZXJzYXRpb24gPSBzdGF0ZS5jb252ZXJzYXRpb25zW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYoY29udmVyc2F0aW9uc1RvQXBwZW5kW2NvbnZlcnNhdGlvbi5pZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgY29udmVyc2F0aW9uc1RvQXBwZW5kW2NvbnZlcnNhdGlvbi5pZF07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgICAgICAgICAgY29udmVyc2F0aW9uczogW1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLnN0YXRlLmNvbnZlcnNhdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAgICAgLi4uKDxhbnk+T2JqZWN0KS52YWx1ZXMoY29udmVyc2F0aW9uc1RvQXBwZW5kKVxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIGluZmluaXRlU2Nyb2xsOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLi4uc3RhdGUuaW5maW5pdGVTY3JvbGwsXHJcbiAgICAgICAgICAgICAgICAgICAgcGFnZTogYWN0aW9uLnBheWxvYWQuaW5maW5pdGVTY3JvbGwucGFnZSxcclxuICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZDogYWN0aW9uLnBheWxvYWQuaW5maW5pdGVTY3JvbGwuZGlzYWJsZWRcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICBjYXNlIE1lc3NhZ2VBY3Rpb25UeXBlcy5VUERBVEVfQ09OVkVSU0FUSU9OX0xBU1RfTUVTU0FHRTpcclxuICAgICAgICAgICAgbGV0IGNvbnZlcnNhdGlvblRvVXBkYXRlO1xyXG4gICAgICAgICAgICB1bnJlYWRNZXNzYWdlc0NvdW50ID0gc3RhdGUudW5yZWFkTWVzc2FnZXNDb3VudDtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGF0ZS5jb252ZXJzYXRpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY29udmVyc2F0aW9uID0gT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUuY29udmVyc2F0aW9uc1tpXSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2F0aW9uLmlkID09IGFjdGlvbi5wYXlsb2FkLmNvbnZlcnNhdGlvbklkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uVG9VcGRhdGUgPSBjb252ZXJzYXRpb247XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRDb252ZXJzYXRpb25zLnB1c2goY29udmVyc2F0aW9uKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY29udmVyc2F0aW9uVG9VcGRhdGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvblRvVXBkYXRlLmxhc3RNZXNzYWdlID0gYWN0aW9uLnBheWxvYWQubGFzdE1lc3NhZ2U7XHJcbiAgICAgICAgICAgICAgICB1cGRhdGVkQ29udmVyc2F0aW9ucy51bnNoaWZ0KGNvbnZlcnNhdGlvblRvVXBkYXRlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoc3RhdGUuYWN0aXZlQ29udmVyc2F0aW9uSWQgIT09IGNvbnZlcnNhdGlvblRvVXBkYXRlLmlkKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgc291bmQgPSBuZXcgQXVkaW8oQ0ROX1VSTCArICcvc291bmRzL21lc3NhZ2UubXAzJyk7XHJcbiAgICAgICAgICAgICAgICBzb3VuZC5wbGF5KCk7XHJcbiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25Ub1VwZGF0ZS51bnJlYWRNZXNzYWdlc0NvdW50Kys7XHJcbiAgICAgICAgICAgICAgICB1bnJlYWRNZXNzYWdlc0NvdW50Kys7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgICAgICAgICAgY29udmVyc2F0aW9uczogdXBkYXRlZENvbnZlcnNhdGlvbnMsXHJcbiAgICAgICAgICAgICAgICB1bnJlYWRNZXNzYWdlc0NvdW50OiB1bnJlYWRNZXNzYWdlc0NvdW50XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgY2FzZSBNZXNzYWdlQWN0aW9uVHlwZXMuU0VUX1VOUkVBRF9NRVNTQUdFU19DT1VOVDpcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgICAgICAgICAgdW5yZWFkTWVzc2FnZXNDb3VudDogYWN0aW9uLnBheWxvYWQudW5yZWFkTWVzc2FnZXNDb3VudFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIGNhc2UgTWVzc2FnZUFjdGlvblR5cGVzLlNFVF9BQ1RJVkVfQ09OVkVSU0FUSU9OX0lEOlxyXG4gICAgICAgICAgICBpZiAoIWFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvbnZlcnNhdGlvbklkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZUNvbnZlcnNhdGlvbklkOiBudWxsXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdXBkYXRlZENvbnZlcnNhdGlvbnMgPSBzdGF0ZS5jb252ZXJzYXRpb25zLm1hcCgoaXRlbSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChpdGVtLmlkICE9PSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb252ZXJzYXRpb25JZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpdGVtO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdW5yZWFkTWVzc2FnZXNDb3VudCA9IHN0YXRlLnVucmVhZE1lc3NhZ2VzQ291bnQgLSBwYXJzZUludChpdGVtLnVucmVhZE1lc3NhZ2VzQ291bnQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAuLi5pdGVtLFxyXG4gICAgICAgICAgICAgICAgICAgIHVucmVhZE1lc3NhZ2VzQ291bnQ6IDBcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgICAgICAgICBhY3RpdmVDb252ZXJzYXRpb25JZDogYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29udmVyc2F0aW9uSWQsXHJcbiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25zOiB1cGRhdGVkQ29udmVyc2F0aW9ucyxcclxuICAgICAgICAgICAgICAgIHVucmVhZE1lc3NhZ2VzQ291bnQ6IHVucmVhZE1lc3NhZ2VzQ291bnRcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgTWVzc2FnZUFjdGlvblR5cGVzLkFQUEVORF9ORVdfQ09OVkVSU0FUSU9OOlxyXG4gICAgICAgICAgICB1bnJlYWRNZXNzYWdlc0NvdW50ID0gc3RhdGUudW5yZWFkTWVzc2FnZXNDb3VudDtcclxuICAgICAgICAgICAgaWYoIWFjdGlvbi5wYXlsb2FkLnNlbGYpIHtcclxuICAgICAgICAgICAgICAgIGxldCBzb3VuZCA9IG5ldyBBdWRpbyhDRE5fVVJMICsgJy9zb3VuZHMvbWVzc2FnZS5tcDMnKTtcclxuICAgICAgICAgICAgICAgIHNvdW5kLnBsYXkoKTtcclxuICAgICAgICAgICAgICAgIHVucmVhZE1lc3NhZ2VzQ291bnQrKztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25zOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uLnBheWxvYWQuY29udmVyc2F0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgIC4uLnN0YXRlLmNvbnZlcnNhdGlvbnNcclxuICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICB1bnJlYWRNZXNzYWdlc0NvdW50OiB1bnJlYWRNZXNzYWdlc0NvdW50XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=